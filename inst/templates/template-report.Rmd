---
title: "Summary Report"
author: "Author"
date: "`r Sys.Date()`"
output: github_document
bibliography: references.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(MATSS)
library(dplyr)
library(tidyr)
library(ggplot2)
library(drake)
library(MATSStest)
```

This report was compiled and generated by the `MATSS` R package[@ye2020MATSS]. 

## Read in the results

As a result of running the Drake pipeline, we have objects for each of the "targets" in the Drake cache. First, let's examine what the names of those targets are:

```{r}
cached()
```

Note that we have two sets of results, one for running the `compute_simpson_index()` function on each dataset, and one for running the `compute_linear_trend()` function on each dataset (producing results for each time series in each dataset).

We can use `loadd()` to load specific targets (or all of them) into the R environment; similar to the base `load()` function for loading in .Rdata files.

Alternatively, we can use `readd()` to return a target directly; similar to the base `readRDS()` function for reading in .RDS files.

### Simpson's Index

First, let's look at the `compute_simpson_index()` results:

```{r}
results_simpson_index <- readd("results_simpson_index")
str(results_simpson_index)
```

The object is a list where each element is the output from the `compute_simpson_index()` function:
* the element names correspond to the name of the analysis and the dataset
* the values are the numeric vectors corresponding to Simpson's index computed at each time step (as described in `?compute_simpson_index`.

### Linear Trends

Now, let's look at the `compute_linear_trend()` results:

```{r}
results_linear_trend <- readd("results_linear_trend")
results_linear_trend
```

Again, the object is a list with a similar structure as previously:
* the element names correspond to the name of the analysis and the dataset
* the values are the tibble outputs from `compute_linear_trend`.

### Total Abundance

Finally, let's look at the `total_abundance()` results:

```{r}
results_total_abundance <- readd("results_total_abundance")
results_total_abundance
```

To process these together into something viewable:

* combine output from separate datasets
* extract just the `results` column
* combine separate tables again, and fix column name

```{r}
results_total_abundance %>%
    bind_rows() %>%
    pull(results) %>%
    bind_rows() %>%
    rename_at(2, ~"abundance") %>%
    knitr::kable()
```

## Prepare for plotting

What we want to plot are the summary statistics for each variable, faceted by the dataset. This suggests the following post-processing of the results:
1) aggregate the results list together, keeping track of the dataset
2) cleaning the dataset names
3) extracting just the `stats` data.frame from each result and expanding out
4) dropping the `times`, `effort`, `richness`, and `tot_obs` rows
5) dropping the `autocorrelation` column

```{r}
to_plot <- results_ts_summary %>%
    bind_rows(.id = "dataset") %>%
    mutate(dataset = sub("analysis_ts_summary_(.+)", "\\1", dataset)) %>%
    select(dataset, stats) %>%
    unnest() %>%
    filter(!(variable %in% c("times", "effort", "richness", "tot_obs"))) %>%
    select(-autocorrelation)
```

## Plot

```{r, fig.height=8}
ggplot(to_plot, aes(x = variable, y = mean)) + 
    geom_crossbar(aes(ymin = mean - sd, ymax = mean + sd)) + 
    facet_wrap(~dataset, scales = "free") + 
    theme_bw() + 
    labs(x = "species", y = "abundance") + 
    theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

## Dataset Citations

```{r, echo = FALSE, results = "asis"}
cat(paste("1.", readd(citations)), sep = "\n")
```

## References
